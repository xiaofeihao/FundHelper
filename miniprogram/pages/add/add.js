"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var netService_1 = require("../../network/netService");
var util_1 = require("../../utils/util");
var app = getApp();
Page({
    data: {
        title: "",
        frontImage: "",
        totalPages: 0,
        currentPage: 0,
        lastDate: "",
        author: "",
        description: "",
        readReason: "",
        thoughts: undefined,
        reading: true,
        percent: 0,
        startPage: 0,
        endPage: 0,
        publishHouse: "",
        publishDate: "",
        openThoughtButton: false
    },
    onLoad: function (option) {
        console.log(option);
        if (Number(option.from) === 0) {
            if (option.errMessage) {
                wx.showToast({
                    title: option.errMessage,
                    icon: 'none',
                    duration: 2000
                });
            }
            else {
                var pages = option.totalPages ? option.totalPages : '0';
                var length_1 = pages.length;
                if (pages.lastIndexOf('页') !== -1) {
                    pages = pages.substring(0, length_1 - 1);
                }
                this.setData({
                    title: option.title ? option.title : "",
                    author: option.author ? option.author : "",
                    frontImage: option.imageId ? netService_1.getBookImage(option.imageId) : "",
                    publishHouse: option.publishHouse ? option.publishHouse : "",
                    totalPages: Number(pages)
                });
            }
        }
        else if (Number(option.from) === 1) {
            console.log("点击手动添加进来的");
        }
    },
    clickImage: function () {
        var pageThis = this;
        wx.chooseImage({
            count: 1,
            sizeType: ['original', 'compressed'],
            sourceType: ['album', 'camera'],
            success: function (res) {
                pageThis.setData({
                    frontImage: res.tempFilePaths[0]
                });
            }
        });
    },
    bookNameInput: function (e) {
        this.setData({
            title: e.detail.value
        });
    },
    bookAuthorInput: function (e) {
        this.setData({
            author: e.detail.value
        });
    },
    bookTotalPageInput: function (e) {
        this.setData({
            totalPages: Number(e.detail.value)
        });
    },
    readingStatusChange: function (e) {
        this.setData({
            reading: e.detail.value
        });
    },
    bookReasonInput: function (e) {
        this.setData({
            readReason: e.detail.value
        });
    },
    bookPublishHouseInput: function (e) {
        this.setData({
            publishHouse: e.detail.value
        });
    },
    bookPublishDateInput: function (e) {
        this.setData({
            publishDate: e.detail.value
        });
    },
    bookDescriptionInput: function (e) {
        this.setData({
            description: e.detail.value
        });
    },
    clickUpdateSave: function () {
        var _this = this;
        var tempPercent = 0;
        if (this.data.totalPages !== 0) {
            tempPercent = this.data.currentPage / this.data.totalPages;
        }
        var book = {
            title: this.data.title,
            frontImage: this.data.frontImage,
            author: this.data.author,
            totalPages: this.data.totalPages,
            readReason: this.data.readReason,
            reading: this.data.reading,
            currentPage: this.data.currentPage,
            lastDate: this.data.lastDate,
            description: this.data.description,
            thoughts: this.data.thoughts,
            percent: tempPercent,
            startPage: this.data.startPage,
            endPage: this.data.endPage,
            publishDate: this.data.publishDate,
            publishHouse: this.data.publishHouse
        };
        var errMessage = util_1.isBookInfoAvailable(book);
        if (errMessage) {
            wx.showToast({
                title: errMessage,
                icon: 'none',
                duration: 2000
            });
        }
        else {
            console.log(book);
            wx.showLoading({
                title: "正在保存...",
                mask: true
            });
            var books_1 = app.globalData.books;
            if (books_1) {
                var tempBook_1 = books_1.filter(function (value) { return value.title === book.title; });
                if (tempBook_1.length > 0) {
                    wx.hideLoading();
                    wx.showModal({
                        title: "同名提示",
                        content: "“" + book.title + "”已经存在，是否覆盖？",
                        success: function (res) {
                            if (res.confirm) {
                                wx.showLoading({
                                    title: "正在保存...",
                                    mask: true
                                });
                                books_1 = books_1.filter(function (value) { return value.title !== tempBook_1[0].title; });
                                books_1.push(book);
                                _this.saveBooks(books_1);
                            }
                        }
                    });
                }
                else {
                    books_1.push(book);
                    this.saveBooks(books_1);
                }
            }
            else {
                books_1 = [];
                books_1.push(book);
                this.saveBooks(books_1);
            }
        }
    },
    saveBooks: function (books) {
        wx.setStorage({
            key: "books",
            data: books,
            success: function () {
                wx.hideLoading();
                wx.navigateBack({
                    delta: 1
                });
            },
            fail: function () {
                wx.hideLoading();
                wx.showToast({
                    title: "保存失败",
                    icon: "none",
                    duration: 2000
                });
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWRkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdURBQXVEO0FBQ3ZELHlDQUFzRDtBQUl0RCxJQUFNLEdBQUcsR0FBRyxNQUFNLEVBQVUsQ0FBQTtBQUU1QixJQUFJLENBQUM7SUFDSCxJQUFJLEVBQUU7UUFDSixLQUFLLEVBQUUsRUFBRTtRQUNULFVBQVUsRUFBRSxFQUFFO1FBQ2QsVUFBVSxFQUFFLENBQUM7UUFDYixXQUFXLEVBQUUsQ0FBQztRQUNkLFFBQVEsRUFBRSxFQUFFO1FBQ1osTUFBTSxFQUFFLEVBQUU7UUFDVixXQUFXLEVBQUUsRUFBRTtRQUNmLFVBQVUsRUFBRSxFQUFFO1FBQ2QsUUFBUSxFQUFFLFNBQVM7UUFDbkIsT0FBTyxFQUFFLElBQUk7UUFDYixPQUFPLEVBQUUsQ0FBQztRQUNWLFNBQVMsRUFBRSxDQUFDO1FBQ1osT0FBTyxFQUFFLENBQUM7UUFDVixZQUFZLEVBQUUsRUFBRTtRQUNoQixXQUFXLEVBQUUsRUFBRTtRQUNmLGlCQUFpQixFQUFFLEtBQUs7S0FDekI7SUFDRCxNQUFNLEVBQU4sVUFBTyxNQUFXO1FBQ2hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEIsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUU3QixJQUFJLE1BQU0sQ0FBQyxVQUFVLEVBQUU7Z0JBRXJCLEVBQUUsQ0FBQyxTQUFTLENBQUM7b0JBQ1gsS0FBSyxFQUFFLE1BQU0sQ0FBQyxVQUFVO29CQUN4QixJQUFJLEVBQUUsTUFBTTtvQkFDWixRQUFRLEVBQUUsSUFBSTtpQkFDZixDQUFDLENBQUE7YUFDSDtpQkFBTTtnQkFDTCxJQUFJLEtBQUssR0FBVyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7Z0JBQ2hFLElBQUksUUFB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Q0FBQTtJQUNKLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRCb29rSW1hZ2UgfSBmcm9tICcuLi8uLi9uZXR3b3JrL25ldFNlcnZpY2UnXG5pbXBvcnQgeyBpc0Jvb2tJbmZvQXZhaWxhYmxlIH0gZnJvbSAnLi4vLi4vdXRpbHMvdXRpbCdcbmltcG9ydCB7IEJvb2sgfSBmcm9tICcuLi8uLi9kYXRhL2RhdGFNb2RlbCdcbmltcG9ydCB7IElNeUFwcCB9IGZyb20gJy4uLy4uL2FwcCdcblxuY29uc3QgYXBwID0gZ2V0QXBwPElNeUFwcD4oKVxuXG5QYWdlKHtcbiAgZGF0YToge1xuICAgIHRpdGxlOiBcIlwiLCAvLyDkuablkI1cbiAgICBmcm9udEltYWdlOiBcIlwiLCAvLyDlm77niYdcbiAgICB0b3RhbFBhZ2VzOiAwLCAvLyDmgLvpobXmlbBcbiAgICBjdXJyZW50UGFnZTogMCwgLy8g5b2T5YmN6ZiF6K+755qE6aG15pWwXG4gICAgbGFzdERhdGU6IFwiXCIsIC8vIOacgOaWsOabtOaWsOaXtumXtCDlubQt5pyILeaXpVxuICAgIGF1dGhvcjogXCJcIiwgLy8g5L2c6ICFXG4gICAgZGVzY3JpcHRpb246IFwiXCIsIC8vIOeugOS7i1xuICAgIHJlYWRSZWFzb246IFwiXCIsIC8vIOWIneW/g++8jOmYheivu+eQhueUsVxuICAgIHRob3VnaHRzOiB1bmRlZmluZWQsIC8vIOaEn+aDs1xuICAgIHJlYWRpbmc6IHRydWUsIC8vIOaYr+WQpuWcqOivu1xuICAgIHBlcmNlbnQ6IDAsIC8vIOW9k+WJjei/m+W6plxuICAgIHN0YXJ0UGFnZTogMCxcbiAgICBlbmRQYWdlOiAwLFxuICAgIHB1Ymxpc2hIb3VzZTogXCJcIixcbiAgICBwdWJsaXNoRGF0ZTogXCJcIixcbiAgICBvcGVuVGhvdWdodEJ1dHRvbjogZmFsc2VcbiAgfSxcbiAgb25Mb2FkKG9wdGlvbjogYW55KSB7XG4gICAgY29uc29sZS5sb2cob3B0aW9uKTtcbiAgICBpZiAoTnVtYmVyKG9wdGlvbi5mcm9tKSA9PT0gMCkge1xuICAgICAgLy8g5omr56CB6L+H5p2l55qEXG4gICAgICBpZiAob3B0aW9uLmVyck1lc3NhZ2UpIHtcbiAgICAgICAgLy8g6K+05piO5pyJ6ZSZ6K+vXG4gICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgdGl0bGU6IG9wdGlvbi5lcnJNZXNzYWdlLFxuICAgICAgICAgIGljb246ICdub25lJyxcbiAgICAgICAgICBkdXJhdGlvbjogMjAwMFxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IHBhZ2VzOiBzdHJpbmcgPSBvcHRpb24udG90YWxQYWdlcyA/IG9wdGlvbi50b3RhbFBhZ2VzIDogJzAnO1xuICAgICAgICBsZXQgbGVuZ3RoOiBudW1iZXIgPSBwYWdlcy5sZW5ndGg7XG4gICAgICAgIGlmIChwYWdlcy5sYXN0SW5kZXhPZign6aG1JykgIT09IC0xKSB7XG4gICAgICAgICAgcGFnZXMgPSBwYWdlcy5zdWJzdHJpbmcoMCwgbGVuZ3RoIC0gMSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgdGl0bGU6IG9wdGlvbi50aXRsZSA/IG9wdGlvbi50aXRsZSA6IFwiXCIsXG4gICAgICAgICAgYXV0aG9yOiBvcHRpb24uYXV0aG9yID8gb3B0aW9uLmF1dGhvciA6IFwiXCIsXG4gICAgICAgICAgZnJvbnRJbWFnZTogb3B0aW9uLmltYWdlSWQgPyBnZXRCb29rSW1hZ2Uob3B0aW9uLmltYWdlSWQpIDogXCJcIixcbiAgICAgICAgICBwdWJsaXNoSG91c2U6IG9wdGlvbi5wdWJsaXNoSG91c2UgPyBvcHRpb24ucHVibGlzaEhvdXNlIDogXCJcIixcbiAgICAgICAgICB0b3RhbFBhZ2VzOiBOdW1iZXIocGFnZXMpXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChOdW1iZXIob3B0aW9uLmZyb20pID09PSAxKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIueCueWHu+aJi+WKqOa3u+WKoOi/m+adpeeahFwiKVxuICAgIH1cblxuICB9LFxuICBjbGlja0ltYWdlKCkge1xuICAgIGNvbnN0IHBhZ2VUaGlzID0gdGhpcztcbiAgICB3eC5jaG9vc2VJbWFnZSh7XG4gICAgICBjb3VudDogMSxcbiAgICAgIHNpemVUeXBlOiBbJ29yaWdpbmFsJywgJ2NvbXByZXNzZWQnXSxcbiAgICAgIHNvdXJjZVR5cGU6IFsnYWxidW0nLCAnY2FtZXJhJ10sXG4gICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICAvLyB0ZW1wRmlsZVBhdGjlj6/ku6XkvZzkuLppbWfmoIfnrb7nmoRzcmPlsZ7mgKfmmL7npLrlm77niYdcbiAgICAgICAgcGFnZVRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgIGZyb250SW1hZ2U6IHJlcy50ZW1wRmlsZVBhdGhzWzBdXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9LFxuICBib29rTmFtZUlucHV0OiBmdW5jdGlvbiAoZTogYW55KSB7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICB0aXRsZTogZS5kZXRhaWwudmFsdWVcbiAgICB9KVxuICB9LFxuICBib29rQXV0aG9ySW5wdXQ6IGZ1bmN0aW9uIChlOiBhbnkpIHtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIGF1dGhvcjogZS5kZXRhaWwudmFsdWVcbiAgICB9KVxuICB9LFxuICBib29rVG90YWxQYWdlSW5wdXQ6IGZ1bmN0aW9uIChlOiBhbnkpIHtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIHRvdGFsUGFnZXM6IE51bWJlcihlLmRldGFpbC52YWx1ZSlcbiAgICB9KVxuICB9LFxuICByZWFkaW5nU3RhdHVzQ2hhbmdlOiBmdW5jdGlvbiAoZTogYW55KSB7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICByZWFkaW5nOiBlLmRldGFpbC52YWx1ZVxuICAgIH0pXG4gIH0sXG4gIGJvb2tSZWFzb25JbnB1dDogZnVuY3Rpb24gKGU6IGFueSkge1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgcmVhZFJlYXNvbjogZS5kZXRhaWwudmFsdWVcbiAgICB9KVxuICB9LFxuICBib29rUHVibGlzaEhvdXNlSW5wdXQ6IGZ1bmN0aW9uIChlOiBhbnkpIHtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIHB1Ymxpc2hIb3VzZTogZS5kZXRhaWwudmFsdWVcbiAgICB9KVxuICB9LFxuICBib29rUHVibGlzaERhdGVJbnB1dDogZnVuY3Rpb24gKGU6IGFueSkge1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgcHVibGlzaERhdGU6IGUuZGV0YWlsLnZhbHVlXG4gICAgfSlcbiAgfSxcbiAgYm9va0Rlc2NyaXB0aW9uSW5wdXQ6IGZ1bmN0aW9uIChlOiBhbnkpIHtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIGRlc2NyaXB0aW9uOiBlLmRldGFpbC52YWx1ZVxuICAgIH0pXG4gIH0sXG4gIGNsaWNrVXBkYXRlU2F2ZSgpIHtcbiAgICAvLyDkv53lrZjkuabnsY3kv6Hmga9cbiAgICBsZXQgdGVtcFBlcmNlbnQgPSAwO1xuICAgIGlmICh0aGlzLmRhdGEudG90YWxQYWdlcyAhPT0gMCkge1xuICAgICAgdGVtcFBlcmNlbnQgPSB0aGlzLmRhdGEuY3VycmVudFBhZ2UgLyB0aGlzLmRhdGEudG90YWxQYWdlcztcbiAgICB9XG4gICAgY29uc3QgYm9vazogQm9vayA9IHtcbiAgICAgIHRpdGxlOiB0aGlzLmRhdGEudGl0bGUsXG4gICAgICBmcm9udEltYWdlOiB0aGlzLmRhdGEuZnJvbnRJbWFnZSxcbiAgICAgIGF1dGhvcjogdGhpcy5kYXRhLmF1dGhvcixcbiAgICAgIHRvdGFsUGFnZXM6IHRoaXMuZGF0YS50b3RhbFBhZ2VzLFxuICAgICAgcmVhZFJlYXNvbjogdGhpcy5kYXRhLnJlYWRSZWFzb24sXG4gICAgICByZWFkaW5nOiB0aGlzLmRhdGEucmVhZGluZyxcbiAgICAgIGN1cnJlbnRQYWdlOiB0aGlzLmRhdGEuY3VycmVudFBhZ2UsXG4gICAgICBsYXN0RGF0ZTogdGhpcy5kYXRhLmxhc3REYXRlLFxuICAgICAgZGVzY3JpcHRpb246IHRoaXMuZGF0YS5kZXNjcmlwdGlvbixcbiAgICAgIHRob3VnaHRzOiB0aGlzLmRhdGEudGhvdWdodHMsXG4gICAgICBwZXJjZW50OiB0ZW1wUGVyY2VudCxcbiAgICAgIHN0YXJ0UGFnZTogdGhpcy5kYXRhLnN0YXJ0UGFnZSxcbiAgICAgIGVuZFBhZ2U6IHRoaXMuZGF0YS5lbmRQYWdlLFxuICAgICAgcHVibGlzaERhdGU6IHRoaXMuZGF0YS5wdWJsaXNoRGF0ZSxcbiAgICAgIHB1Ymxpc2hIb3VzZTogdGhpcy5kYXRhLnB1Ymxpc2hIb3VzZVxuICAgIH1cbiAgICBsZXQgZXJyTWVzc2FnZSA9IGlzQm9va0luZm9BdmFpbGFibGUoYm9vayk7XG4gICAgaWYgKGVyck1lc3NhZ2UpIHtcbiAgICAgIC8vIOaciemXrumimO+8jOW8ueWHunRvYXN05o+Q56S6XG4gICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICB0aXRsZTogZXJyTWVzc2FnZSxcbiAgICAgICAgaWNvbjogJ25vbmUnLFxuICAgICAgICBkdXJhdGlvbjogMjAwMFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOayoeaciemXrumimO+8jOWPr+S7peS/neWtmFxuICAgICAgY29uc29sZS5sb2coYm9vayk7XG4gICAgICB3eC5zaG93TG9hZGluZyh7XG4gICAgICAgIHRpdGxlOiBcIuato+WcqOS/neWtmC4uLlwiLFxuICAgICAgICBtYXNrOiB0cnVlXG4gICAgICB9KTtcbiAgICAgIGxldCBib29rczogQXJyYXk8Qm9vaz4gPSBhcHAuZ2xvYmFsRGF0YS5ib29rcztcbiAgICAgIGlmIChib29rcykge1xuICAgICAgICBsZXQgdGVtcEJvb2s6IEFycmF5PEJvb2s+ID0gYm9va3MuZmlsdGVyKHZhbHVlID0+IHZhbHVlLnRpdGxlID09PSBib29rLnRpdGxlKTtcbiAgICAgICAgaWYgKHRlbXBCb29rLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB3eC5oaWRlTG9hZGluZygpO1xuICAgICAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgICAgICB0aXRsZTogXCLlkIzlkI3mj5DnpLpcIixcbiAgICAgICAgICAgIGNvbnRlbnQ6IFwi4oCcXCIgKyBib29rLnRpdGxlICsgXCLigJ3lt7Lnu4/lrZjlnKjvvIzmmK/lkKbopobnm5bvvJ9cIixcbiAgICAgICAgICAgIHN1Y2Nlc3M6IChyZXMpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHJlcy5jb25maXJtKSB7XG4gICAgICAgICAgICAgICAgd3guc2hvd0xvYWRpbmcoe1xuICAgICAgICAgICAgICAgICAgdGl0bGU6IFwi5q2j5Zyo5L+d5a2YLi4uXCIsXG4gICAgICAgICAgICAgICAgICBtYXNrOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYm9va3MgPSBib29rcy5maWx0ZXIodmFsdWUgPT4gdmFsdWUudGl0bGUgIT09IHRlbXBCb29rWzBdLnRpdGxlKTtcbiAgICAgICAgICAgICAgICBib29rcy5wdXNoKGJvb2spO1xuICAgICAgICAgICAgICAgIHRoaXMuc2F2ZUJvb2tzKGJvb2tzKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGJvb2tzLnB1c2goYm9vayk7XG4gICAgICAgICAgdGhpcy5zYXZlQm9va3MoYm9va3MpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBib29rcyA9IFtdO1xuICAgICAgICBib29rcy5wdXNoKGJvb2spO1xuICAgICAgICB0aGlzLnNhdmVCb29rcyhib29rcyk7XG4gICAgICB9XG4gICAgfVxuICB9LFxuICBzYXZlQm9va3MoYm9va3M6IEFycmF5PEJvb2s+KSB7XG4gICAgd3guc2V0U3RvcmFnZSh7XG4gICAgICBrZXk6IFwiYm9va3NcIixcbiAgICAgIGRhdGE6IGJvb2tzLFxuICAgICAgc3VjY2VzczogKCk9PntcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoKTtcbiAgICAgICAgd3gubmF2aWdhdGVCYWNrKHtcbiAgICAgICAgICBkZWx0YTogMVxuICAgICAgICB9KVxuICAgICAgfSxcbiAgICAgIGZhaWw6ICgpPT57XG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XG4gICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgdGl0bGU6IFwi5L+d5a2Y5aSx6LSlXCIsXG4gICAgICAgICAgaWNvbjogXCJub25lXCIsXG4gICAgICAgICAgZHVyYXRpb246IDIwMDBcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSlcbiAgfVxufSkiXX0=